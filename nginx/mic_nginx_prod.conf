
# Production NGINX Configuration for MIC Application

# Upstream server group for the Gunicorn application
# This allows for easy load balancing if you run multiple instances
upstream mic_server {
    server 127.0.0.1:8001;
}

# Server block for redirecting HTTP to HTTPS
server {
    listen 80;
    server_name your_domain.com www.your_domain.com; # <-- IMPORTANT: Replace with your actual domain

    # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently
    return 301 https://$host$request_uri;
}

# Main server block for the application (HTTPS)
server {
    listen 443 ssl http2;
    server_name your_domain.com www.your_domain.com; # <-- IMPORTANT: Replace with your actual domain

    # --- SSL Configuration ---
    # IMPORTANT: Replace these paths with your actual SSL certificate files.
    # Use Let's Encrypt (certbot) to get free SSL certificates.
    # ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem;
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # --- Static Files ---
    # NGINX serves static files directly for better performance.
    location /static {
        # IMPORTANT: The path here is an example for a Windows server.
        # On a Linux server, this would be an absolute path like '/var/www/mic/static'.
        alias E:\mic\static; 
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # --- Application Proxy ---
    # All other requests are proxied to the Gunicorn server.
    location / {
        proxy_pass http://mic_server;
        
        # Set headers to pass information to the backend application
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Required for WebSocket support (used by FastAPI/Starlette)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # --- Security Headers (optional but recommended) ---
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY"; # Prevents clickjacking
    add_header Referrer-Policy "no-referrer-when-downgrade"; # Controls referrer information
    # A robust Content-Security-Policy is highly application-specific.
    # This is a basic example; adjust 'default-src', 'script-src', 'style-src' etc. as needed.
    # For production, consider a stricter policy and report-uri.
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';";
    server_tokens off; # Hide NGINX version
}
